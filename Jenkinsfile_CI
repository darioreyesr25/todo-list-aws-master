pipeline {
    agent any
    environment {
        ENV = "${env.BRANCH_NAME == 'master' ? 'production' : 'staging'}"
    }
    stages {
        stage('Get Code') {
            steps {
                sh '''
                    echo "La rama es: $BRANCH_NAME"
                    rm -rf todo-list-aws-master
                    if [ "$ENV" = "production" ]; then
                        BRANCH=master
                    else
                        BRANCH=develop
                    fi
                    git clone --branch $BRANCH https://github.com/darioreyesr25/todo-list-aws-master.git
                    ls todo-list-aws-master
                '''
                echo WORKSPACE
            }
        }
        stage('Static') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    sh '''
                        cd todo-list-aws-master
                        flake8 --exit-zero --format=pylint src > flake8.out
                    '''
                    recordIssues(
                        tools: [flake8(name: 'Flake8', pattern: 'todo-list-aws-master/flake8.out')],
                        qualityGates: [
                                [threshold: 8, type: 'TOTAL', unstable: true],
                                [threshold: 10, type: 'TOTAL', unstable: false]
                        ]
                    )
                }
            }
        }
        stage('Security Test') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    sh '''
                        cd todo-list-aws-master
                        bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                        test -f bandit.out || touch bandit.out
                    '''
                    sh 'cat todo-list-aws-master/bandit.out || true'
                    archiveArtifacts artifacts: 'todo-list-aws-master/bandit.out', onlyIfSuccessful: false
                }
            }
        }
        stage('Deploy') {
            steps {
                sh '''
                    cd todo-list-aws-master
                    sam build
                    sam deploy --config-env $ENV --no-confirm-changeset --no-fail-on-empty-changeset || true
                    if [ "$ENV" = "production" ]; then
                        STACK_NAME=todo-list-aws-production
                    else
                        STACK_NAME=todo-list-aws-staging
                    fi
                    export BASE_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" --output text)
                    echo "BASE_URL obtenido: $BASE_URL"
                    echo $BASE_URL > ../base_url.txt
                '''
                stash includes: 'base_url.txt', name: 'baseurlfile'
            }
        }
        stage('Rest Test') {
            steps {
                unstash 'baseurlfile'
                sh '''
                    cd todo-list-aws-master
                    export BASE_URL=$(cat ../base_url.txt)
                    export PYTHONPATH=$WORKSPACE
                    if [ "$ENV" = "production" ]; then
                        pytest test/integration/todoApiTest.py -k "get or list" --junitxml=integration_test_report.xml || true
                    else
                        pytest test/integration/todoApiTest.py --junitxml=integration_test_report.xml || true
                    fi
                '''
                junit allowEmptyResults: true, testResults: 'todo-list-aws-master/integration_test_report.xml'
            }
        }

        stage('Promote') {
            when {
                expression { return ENV != 'production' }
            }
            options {
                skipDefaultCheckout(true)
            }
            steps {
                script {
                    currentBuild.result = 'SUCCESS'
                }
                withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                    sh '''
                        cd todo-list-aws-master
                        fecha=$(date +"%Y-%m-%d")
                        version="$(git describe --tags --abbrev=0 2>/dev/null || echo 1.0.0)"
                        echo -e "\n## [Release] - $fecha\n### Promoción a producción\n" >> CHANGELOG.md
                        git add CHANGELOG.md
                        git commit -m "chore: marcar versión $version como Release en CHANGELOG.md"
                        git checkout master
                        git merge develop
                        git push https://${GIT_USER}:${GIT_TOKEN}@github.com/darioreyesr25/todo-list-aws-master.git master
                    '''
                }
            }
        }
    }
}
