pipeline {
    agent any
    environment {
        // Detecta el entorno según la rama: master=production, otro=staging
        ENV = "${env.BRANCH_NAME == 'master' ? 'production' : 'staging'}"
    }
    stages {
        // Definición de las etapas del pipeline
        // Cada etapa representa una fase del proceso de integración continua
        // Etapa para obtener el código fuente del repositorio
        stage('Get Code') {
            steps {
                // Clonar el repositorio en el workspace desde la rama correspondiente
                sh '''
                    echo "La rama es: $BRANCH_NAME"
                    rm -rf todo-list-aws-master
                    if [ "$ENV" = "production" ]; then
                        BRANCH=master
                    elif [ "$ENV" = "staging" ]; then
                        BRANCH=develop
                    else
                        BRANCH=develop
                    fi
                    git clone --branch $BRANCH https://github.com/darioreyesr25/todo-list-aws-master.git
                    ls todo-list-aws-master
                '''
                // Stash del repositorio para compartir entre agentes
                stash includes: 'todo-list-aws-master/**', name: 'repo'
                echo WORKSPACE
            }
        }
        // Etapa para análisis estático de código con flake8
        stage('Static') {
            agent { label 'agente2' }
            steps {
                unstash 'repo'
                sh 'whoami'
                sh 'hostname'
                // Ejecución de flake8 ignorando errores de salida para que el pipeline continúe
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    // Ejecución de flake8 y redirección de la salida a un archivo
                    sh '''
                        cd todo-list-aws-master
                        flake8 --exit-zero --format=pylint src > flake8.out
                    '''
                    
                    // Registro de incidencias con Warnings Next Generation Plugin
                    recordIssues(
                        tools: [flake8(name: 'Flake8', pattern: 'todo-list-aws-master/flake8.out')],
                        qualityGates: [
                                // Si hay más de 8 avisos: UNSTABLE (Amarillo)
                                [threshold: 8, type: 'TOTAL', unstable: true],
                                // Si hay más de 11 avisos: FAILURE (Rojo)
                                [threshold: 10, type: 'TOTAL', unstable: false]
                        ]
                    )
                }
            }
        }

        stage('Security Test') {
            agent { label 'agente2' }
            steps {
                unstash 'repo'
                sh 'whoami'
                sh 'hostname'
                // Ejecución de Bandit ignorando errores de salida para que el pipeline continúe
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    // Ejecución de Bandit y redirección de la salida a un archivo
                    sh '''
                        cd todo-list-aws-master
                        bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                        # Garantizar que el archivo bandit.out exista aunque esté vacío
                        test -f bandit.out || touch bandit.out
                    '''
                    // Mostrar el reporte de Bandit en la consola
                    sh 'cat todo-list-aws-master/bandit.out || true'
                    // Archivar el reporte de Bandit como artefacto descargable
                    archiveArtifacts artifacts: 'todo-list-aws-master/bandit.out', onlyIfSuccessful: false
                }
            }
        }

        //Etapa desplegar aplicación en AWS
        stage('Deploy') {
            steps {
                // Despliegue de la aplicación en AWS utilizando SAM CLI
                sh '''
                    cd todo-list-aws-master
                    sam build
                    sam deploy --config-env $ENV --no-confirm-changeset --no-fail-on-empty-changeset || true
                    # Obtener la URL del API Gateway del output de CloudFormation
                    if [ "$ENV" = "production" ]; then
                        STACK_NAME=todo-list-aws-production
                    else
                        STACK_NAME=todo-list-aws-staging
                    fi
                    export BASE_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" --output text)
                    echo "BASE_URL obtenido: $BASE_URL"
                    echo $BASE_URL > ../base_url.txt
                '''
                // Guardar el archivo base_url.txt para otras etapas
                stash includes: 'base_url.txt', name: 'baseurlfile'
            }
        }

        //etapa para ejecutar pruebas de integración con pytest
        stage('Rest Test') {
            agent { label 'agente2' }
            steps {
                unstash 'repo'
                sh 'whoami'
                sh 'hostname'
                // Recuperar el archivo base_url.txt guardado en la etapa Deploy
                unstash 'baseurlfile'
                sh '''
                    cd todo-list-aws-master
                    export BASE_URL=$(cat ../base_url.txt)
                    export PYTHONPATH=$WORKSPACE
                    # Generar el reporte para junits
                    if [ "$ENV" = "production" ]; then
                        pytest test/integration/todoApiTest.py -k "get or list" --junitxml=integration_test_report.xml || true
                    else
                        pytest test/integration/todoApiTest.py --junitxml=integration_test_report.xml || true
                    fi
                '''
                junit allowEmptyResults: true, testResults: 'todo-list-aws-master/integration_test_report.xml'
            }
        }

        //Etapa “Promote” para marcar la versión como “Release” en el archivo CHANGELOG.md y ser desplegada en producción. Y hacer merge a master si la promoción es exitosa. Esta etapa solo se ejecutará si el entorno no es producción, para evitar que se ejecute en master y cause un bucle infinito de promociones.
        stage('Promote') {
            when {
                expression { return ENV != 'production' }
            }
            // Omitir la etapa de promoción en entornos que no son producción, pero marcar el build como SUCCESS para que el pipeline no se marque como inestable sino como exitoso, ya que no es un error sino una decisión de omitir esta etapa en entornos que no son producción
            options {
                skipDefaultCheckout(true)
            }
            steps {
                script {
                    // Si la etapa se omite, no marcar UNSTABLE sino SUCCESS para que el pipeline no se marque como inestable sino como exitoso, ya que no es un error sino una decisión de omitir esta etapa en entornos que no son producción
                    currentBuild.result = 'SUCCESS'
                }
                withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                    sh '''
                        cd todo-list-aws-master
                        # Marcar como Release en el CHANGELOG.md
                        fecha=$(date +"%Y-%m-%d")
                        version="$(git describe --tags --abbrev=0 2>/dev/null || echo 1.0.0)"
                        echo -e "\n## [Release] - $fecha\n### Promoción a producción\n" >> CHANGELOG.md
                        git add CHANGELOG.md
                        git commit -m "chore: marcar versión $version como Release en CHANGELOG.md"
                        # Merge a master
                        git checkout master
                        git merge develop
                        git push https://${GIT_USER}:${GIT_TOKEN}@github.com/darioreyesr25/todo-list-aws-master.git master
                    '''
                }
            }
        }
    }    
}